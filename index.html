<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tactical HUD</title>
    <script src="https://cdn.jsdelivr.net/npm/mgrs@1.0.0/dist/mgrs.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        
        /* カメラ映像（背景） */
        #video-feed { position: fixed; width: 100vw; height: 100vh; object-fit: cover; z-index: 1; }
        
        /* UI層：Canvasで描画 */
        #canvas-ui { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 10; pointer-events: none; }
        
        /* 撮影・起動ボタン共通スタイル */
        .btn {
            position: fixed; z-index: 20; padding: 15px 25px; 
            cursor: pointer; background: #111; color: #00ff00; 
            border: 2px solid #00ff00; font-family: monospace; font-size: 1.1rem;
        }

        /* 起動ボタン：画面中央 */
        #start-btn { top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* 撮影ボタン：右下（Safe Areaを考慮） */
        #snap-btn {
            bottom: max(20px, env(safe-area-inset-bottom)); right: 20px;
            display: none; border-radius: 50%; aspect-ratio: 1; padding: 20px;
        }
    </style>
</head>
<body>
    <video id="video-feed" autoplay playsinline muted></video>
    <canvas id="canvas-ui"></canvas>
    <button id="start-btn" class="btn">INITIALIZE HUD</button>
    <button id="snap-btn" class="btn">○</button>

    <script>
        const btn = document.getElementById('start-btn');
        const snapBtn = document.getElementById('snap-btn');
        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas-ui');
        const ctx = canvas.getContext('2d');
        let currentMGRS = "INITIALIZING...";
        let currentMIL = "0000";

        // Canvasサイズを画面に合わせる
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 描画ループ：毎フレーム実行
        function drawHUD() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 1;

            // --- 1. 十字線 ---
            ctx.beginPath();
            ctx.moveTo(centerX, 0); ctx.lineTo(centerX, canvas.height);
            ctx.moveTo(0, centerY); ctx.lineTo(canvas.width, centerY);
            ctx.stroke();

            // --- 2. MGRS座標（縦線の右に収める） ---
            ctx.font = '16px monospace';
            const mgrsPrefix = "MGRS: ";
            const fullMGRSText = mgrsPrefix + currentMGRS;
            const mgrsWidth = ctx.measureText(fullMGRSText).width;
            const padding = 10;

            // 半透明の背景パネル
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            // 配置位置：画面中央（縦線）の右側に少しパディングを入れて描画
            ctx.fillRect(centerX + padding, padding, mgrsWidth + (padding * 2), 30);

            // テキスト描画
            ctx.fillStyle = '#00ff00';
            ctx.fillText(fullMGRSText, centerX + (padding * 2), 31);

            // --- 3. MIL表示（下部中央） ---
            ctx.font = '2.5rem monospace';
            const milText = currentMIL + " MIL";
            const milWidth = ctx.measureText(milText).width;

            // 半透明背景
            ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
            ctx.fillRect(centerX - (milWidth / 2) - 10, canvas.height - 75, milWidth + 20, 50);

            // テキスト
            ctx.fillStyle = '#00ff00';
            ctx.fillText(milText, centerX - (milWidth / 2), canvas.height - 35);

            requestAnimationFrame(drawHUD);
        }
        drawHUD();

        // MGRS整形
        function formatMGRS(str) { return str.replace(/(\w{5})(\d{5})(\d{5})/, '$1 $2 $3'); }

        // 初期化ボタンイベント
        btn.addEventListener('click', async () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                const res = await DeviceOrientationEvent.requestPermission();
                if (res !== 'granted') return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                
                // 起動成功：ボタンを切り替え
                btn.style.display = 'none';
                snapBtn.style.display = 'block';

                // GPS監視
                navigator.geolocation.watchPosition((pos) => {
                    const res = mgrs.forward([pos.coords.longitude, pos.coords.latitude]);
                    currentMGRS = formatMGRS(res);
                }, null, { enableHighAccuracy: true });

                // コンパス監視
                window.addEventListener('deviceorientation', (event) => {
                    let heading = event.webkitCompassHeading;
                    if (heading !== null) {
                        currentMIL = Math.round(heading * (6400 / 360)).toString().padStart(4, '0');
                    }
                });

            } catch (e) { alert("カメラエラー: " + e.message); }
        });

        // 撮影機能の実装
        snapBtn.addEventListener('click', () => {
            const captureCanvas = document.createElement('canvas');
            captureCanvas.width = canvas.width;
            captureCanvas.height = canvas.height;
            const captureCtx = captureCanvas.getContext('2d');

            // 1. ビデオ映像を描画
            captureCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            // 2. HUDを描画（Canvasの中身をそのままコピー）
            captureCtx.drawImage(canvas, 0, 0);

            // 3. 画像としてダウンロード
            const link = document.createElement('a');
            link.download = `TacticalHUD_${Date.now()}.png`;
            link.href = captureCanvas.toDataURL('image/png');
            link.click();
        });
    </script>
</body>
</html>
