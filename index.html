<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MIL Compass</title>
    <script src="mgrs.min.js"></script>
    <style>
        body { background: #1a1a1a; color: #00ff00; font-family: monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        
        #mgrs-display { position: absolute; top: 10px; right: 10px; font-size: 0.9rem; text-align: right; }

        /* コンパス本体 */
        #compass-face {
            width: 300px; height: 300px;
            border: 4px solid #00ff00; border-radius: 50%;
            position: relative;
            margin-top: 50px;
        }

        /* 東西南北のラベル */
        .dir-label { position: absolute; font-size: 20px; font-weight: bold; color: #00ff00; }
        .n { top: -35px; left: 50%; transform: translateX(-50%); }
        .e { top: 50%; right: -30px; transform: translateY(-50%); }
        .s { bottom: -35px; left: 50%; transform: translateX(-50%); }
        .w { top: 50%; left: -30px; transform: translateY(-50%); }

        /* 針 */
        #needle {
            width: 4px; height: 120px; background: #ff0000;
            position: absolute; left: 50%; bottom: 50%;
            transform-origin: bottom center;
            transform: translateX(-50%);
            transition: transform 0.05s linear;
        }

        .tick-container { position: absolute; width: 100%; height: 100%; top: 0; left: 0; }
        .tick { width: 2px; height: 15px; background: #00ff00; margin: 0 auto; }
        .long-tick { height: 30px; background: #ffffff; width: 3px; } /* 800ミル用 */

        #display { font-size: 3rem; margin-top: 40px; }
    </style>
</head>
<body>

    <div id="mgrs-display">MGRS: START...</div>

    <div id="compass-face">
        <div class="dir-label n">N</div>
        <div class="dir-label e">E</div>
        <div class="dir-label s">S</div>
        <div class="dir-label w">W</div>
        <div id="needle"></div>
    </div>
    
    <div id="display">0000 MIL</div>
    <button id="start-btn" style="padding:20px; font-size:1.2rem; margin-top:30px;">起動 (センサー許可)</button>

    <script>
        const face = document.getElementById('compass-face');
        const needle = document.getElementById('needle');
        const display = document.getElementById('display');
        const btn = document.getElementById('start-btn');
        const mgrsText = document.getElementById('mgrs-display');

        // メモリ描画
        for (let i = 0; i < 32; i++) {
            const container = document.createElement('div');
            container.className = 'tick-container';
            container.style.transform = `rotate(${i * 11.25}deg)`;
            
            const tick = document.createElement('div');
            // 800ミル毎（i*200が800の倍数）
            if ((i * 200) % 800 === 0) {
                tick.className = 'tick long-tick';
            } else {
                tick.className = 'tick';
            }
            container.appendChild(tick);
            face.appendChild(container);
        }

        btn.addEventListener('click', async () => {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                const p1 = await DeviceOrientationEvent.requestPermission();
                if (p1 !== 'granted') return;
            }
            
            // 位置情報取得
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition((pos) => {
                    try {
                        const coords = [pos.coords.longitude, pos.coords.latitude];
                        // オフラインでもライブラリが読み込まれていれば動く
                        const mgrsResult = mgrs.forward(coords);
                        mgrsText.innerText = `MGRS:\n${mgrsResult}`;
                    } catch(e) { mgrsText.innerText = "MGRS Err"; }
                });
            }

            btn.style.display = 'none';
            startCompass();
        });

        function startCompass() {
            window.addEventListener('deviceorientation', (event) => {
                let heading = event.webkitCompassHeading;
                if (heading !== null) {
                    needle.style.transform = `translateX(-50%) rotate(${heading}deg)`;
                    let mils = Math.round(heading * (6400 / 360));
                    display.innerText = mils.toString().padStart(4, '0') + " MIL";
                }
            });
        }
    </script>
</body>
</html>